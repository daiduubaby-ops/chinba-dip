<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Reading - {{ book.title }}</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
      /* Make reader occupy most of the viewport so pages appear fullscreen.
         Force the reader element to expand beyond the normal container width so
         the image can take up most of the viewport. */
      .reader {display:flex;gap:1rem;align-items:center; height: calc(100vh - 220px); margin:1rem auto 0; width:auto; max-width:1100px; justify-content:center; perspective:1200px}
      /* Fullscreen-like single page appearance: dark background and centered image */
      .page {
        /* two pages side-by-side, each takes about half of the reader area
           but constrained so the spread is centered */
        flex:0 0 calc(50% - 0.5rem);
        height:100%;
        border-radius:6px;
        padding:0;
        display:flex;
        align-items:center;
        justify-content:center;
        background:#000; /* dark background so pages "pop" */
        overflow:hidden;
        transition: transform 600ms ease, box-shadow 600ms ease;
        backface-visibility: hidden;
      }
      .page img{max-width:100%;max-height:100%;object-fit:contain;display:block}
      /* When reader is fullscreen, use full-bleed spread layout so two pages are visible.
         Include vendor variants for broader browser support. */
      .reader:fullscreen,
      .reader:-webkit-full-screen,
      .reader:-moz-full-screen,
      .reader:-ms-fullscreen {
        display:flex;
        width:100vw !important;
        height:100vh !important;
        max-width:100vw !important;
        margin:0 !important;
        gap:2rem !important;
        justify-content:center;
        align-items:center;
      }
      .reader:fullscreen > .page,
      .reader:-webkit-full-screen > .page,
      .reader:-moz-full-screen > .page,
      .reader:-ms-fullscreen > .page{
        flex:0 0 calc(50% - 2rem) !important;
        height:100% !important;
        display:flex !important;
      }
      /* ensure images take the available height in fullscreen spread */
      .reader:fullscreen .page img,
      .reader:-webkit-full-screen .page img,
      .reader:-moz-full-screen .page img,
      .reader:-ms-fullscreen .page img{
        width:auto !important;
        height:100% !important;
        object-fit:contain !important;
      }
      /* allow single-page mode while in fullscreen: override spread rules */
      .reader:fullscreen .page.single,
      .reader:-webkit-full-screen .page.single,
      .reader:-moz-full-screen .page.single,
      .reader:-ms-fullscreen .page.single {
        flex:0 0 100% !important;
        max-width:100% !important;
      }
      .reader:fullscreen .page.single img,
      .reader:-webkit-full-screen .page.single img,
      .reader:-moz-full-screen .page.single img,
      .reader:-ms-fullscreen .page.single img {
        width:100% !important;
        height:auto !important;
        object-fit:contain !important;
      }
      /* single page view: take full width */
      .page.single{flex:0 0 100%}
      /* page-turn animations using keyframes for reliable 3D flip */
      .page{will-change:transform,opacity}
      /* stronger flip animations (include -webkit- prefix for Chrome) */
      .reader.flip-next .page:first-child{animation:flipOutLeft 640ms cubic-bezier(.2,.8,.2,1) forwards; -webkit-animation:flipOutLeft 640ms cubic-bezier(.2,.8,.2,1) forwards}
      .reader.flip-next .page:last-child{animation:flipInRight 640ms cubic-bezier(.2,.8,.2,1) forwards; -webkit-animation:flipInRight 640ms cubic-bezier(.2,.8,.2,1) forwards}
      .reader.flip-prev .page:first-child{animation:flipInLeft 640ms cubic-bezier(.2,.8,.2,1) forwards; -webkit-animation:flipInLeft 640ms cubic-bezier(.2,.8,.2,1) forwards}
      .reader.flip-prev .page:last-child{animation:flipOutRight 640ms cubic-bezier(.2,.8,.2,1) forwards; -webkit-animation:flipOutRight 640ms cubic-bezier(.2,.8,.2,1) forwards}
      .page{transform-style:preserve-3d}
      .page{transform-style:preserve-3d; -webkit-transform-style:preserve-3d; position:relative; transform-origin:center center}
      .page img{backface-visibility:hidden; -webkit-backface-visibility:hidden}
      /* ensure reader preserves 3D perspective in all browsers */
      .reader{perspective:1200px; -webkit-perspective:1200px}
      /* make sure pages stack correctly during flip */
      .reader .page{z-index:1}
      .reader.flip-next .page:first-child{z-index:3; transform-origin:left center}
      .reader.flip-next .page:last-child{z-index:2; transform-origin:right center}
      .reader.flip-prev .page:first-child{z-index:2; transform-origin:left center}
      .reader.flip-prev .page:last-child{z-index:3; transform-origin:right center}
      @keyframes flipOutLeft{from{transform:rotateY(0) translateZ(0);opacity:1}to{transform:rotateY(-120deg) translateX(-40%) translateZ(-280px);opacity:0}}
      @-webkit-keyframes flipOutLeft{from{-webkit-transform:rotateY(0) translateZ(0);opacity:1}to{-webkit-transform:rotateY(-120deg) translateX(-40%) translateZ(-280px);opacity:0}}
      @keyframes flipInRight{from{transform:rotateY(120deg) translateX(40%) translateZ(-280px);opacity:0}to{transform:rotateY(0) translateZ(0);opacity:1}}
      @-webkit-keyframes flipInRight{from{-webkit-transform:rotateY(120deg) translateX(40%) translateZ(-280px);opacity:0}to{-webkit-transform:rotateY(0) translateZ(0);opacity:1}}
      @keyframes flipInLeft{from{transform:rotateY(-120deg) translateX(-40%) translateZ(-280px);opacity:0}to{transform:rotateY(0) translateZ(0);opacity:1}}
      @-webkit-keyframes flipInLeft{from{-webkit-transform:rotateY(-120deg) translateX(-40%) translateZ(-280px);opacity:0}to{-webkit-transform:rotateY(0) translateZ(0);opacity:1}}
      @keyframes flipOutRight{from{transform:rotateY(0) translateZ(0);opacity:1}to{transform:rotateY(120deg) translateX(40%) translateZ(-280px);opacity:0}}
      @-webkit-keyframes flipOutRight{from{-webkit-transform:rotateY(0) translateZ(0);opacity:1}to{-webkit-transform:rotateY(120deg) translateX(40%) translateZ(-280px);opacity:0}}
      /* simple incoming animation used after rendering new single-page content */
      @keyframes readerFlipInSimple{from{transform:scale(0.98) translateY(6px); opacity:0}to{transform:scale(1) translateY(0); opacity:1}}
      .reader.flip-in .page{animation: readerFlipInSimple 420ms cubic-bezier(.2,.8,.2,1) forwards}
      /* single-page outgoing/incoming animations (used in single-page fullscreen mode) */
      .single-out-next{animation:singleOutNext 360ms ease forwards}
      .single-out-prev{animation:singleOutPrev 360ms ease forwards}
      .single-in{animation:singleIn 420ms cubic-bezier(.2,.8,.2,1) forwards}
      @keyframes singleOutNext{from{transform:translateX(0) scale(1);opacity:1}to{transform:translateX(-24%) scale(.98);opacity:0}}
      @keyframes singleOutPrev{from{transform:translateX(0) scale(1);opacity:1}to{transform:translateX(24%) scale(.98);opacity:0}}
      @keyframes singleIn{from{transform:translateY(8px) scale(.98);opacity:0}to{transform:translateY(0) scale(1);opacity:1}}
      .reader-controls{margin:1rem 0;display:flex;gap:.5rem;align-items:center}
      .primary{background:var(--accent);color:#fff;padding:.5rem .8rem;border-radius:6px;border:none}
      /* Page number input */
      #pageInput{width:72px;padding:.4rem;border:1px solid #e5e7eb;border-radius:6px}
    </style>
  </head>
  <body>
    <div class="container">
      <nav class="nav">
        <div class="nav-left">
          <a href="/" class="logo">Хүүхдийн&nbsp;Номын&nbsp;Клуб</a>
        </div>
        <div class="nav-right">
          <a href="/books">Номнууд</a>
          {% if session.get('username') %}
            <span class="profile-pill">{{ session.username }}</span>
            <a href="/profile">Профайл</a>
            <a href="/logout">Гарах</a>
          {% else %}
            <a href="/login" class="login-button">Нэвтрэх</a>
          {% endif %}
        </div>
      </nav>

      <main>
        <a href="{{ url_for('book_detail', book_id=book.id) }}" class="back">← Номны дэлгэрэнгүй руу буцах</a>
        <h1>Уншиж байна: {{ book.title }}</h1>

        <div class="reader-controls">
        <button id="prev" class="primary">Өмнөх</button>
        <button id="toggleSingle" class="primary">Нэг хуудас</button>
        <button id="fullscreenBtn" class="primary">Бүх хуудас</button>
        <div style="font-weight:600">Хуудас <span id="pageNum">1</span></div>
        <input type="number" id="pageInput" min="1" value="1" />
        <div id="pageOf" style="color:#374151;margin-left:4px">/ 0</div>
        <button id="next" class="primary">Дараа</button>
        </div>

        <div class="reader" id="reader">
          {% if pages and pages|length > 0 %}
            <div class="page"><img src="{{ pages[0] }}" /></div>
            <div class="page">{% if pages|length > 1 %}<img src="{{ pages[1] }}" />{% endif %}</div>
          {% else %}
            <div class="page"></div>
            <div class="page"></div>
          {% endif %}
        </div>
        <script id="pages-data" type="application/json">{{ pages|tojson|safe }}</script>
        <script>
          // expose pages array to external reader script
          try{ window.PAGES = JSON.parse(document.getElementById('pages-data').textContent || '[]') }catch(e){ window.PAGES = [] }
        </script>
        <script src="/static/reader.js"></script>
        <section id="reader-debug" style="margin-top:1rem;font-size:.9rem;color:#374151">
          <details>
            <summary>Pages (debug)</summary>
            <div id="pages-list">Loading…</div>
          </details>
        </section>
      </main>
    </div>

      
    {% if session.get('user_id') %}
    <script>
      // Start a reading session when the reader loads and stop on unload.
      (function(){
        let readerSessionId = null
        const bookId = {{ book.id | tojson }}

        function startSession(){
          try{
            fetch('/reading/start', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              credentials: 'same-origin',
              body: JSON.stringify({book_id: bookId})
            }).then(r=>r.json()).then(j=>{ if(j && j.session_id) readerSessionId = j.session_id }).catch(()=>{})
          }catch(e){}
        }

        function stopSession(){
          try{
            if(!readerSessionId) return
            fetch('/reading/stop', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              credentials: 'same-origin',
              body: JSON.stringify({session_id: readerSessionId}),
              keepalive: true
            }).catch(()=>{})
          }catch(e){}
        }

        // start immediately
        startSession()

        // attempt to stop when the page is unloaded
        window.addEventListener('beforeunload', stopSession)
        // also stop when the document becomes hidden (user switches tabs) to be conservative
        document.addEventListener('visibilitychange', function(){ if(document.hidden) stopSession() })
      })()
    </script>
    {% endif %}
  </body>
  </html>
