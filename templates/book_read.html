<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Reading - {{ book.title }}</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
      /* Make reader occupy most of the viewport so pages appear fullscreen.
         Force the reader element to expand beyond the normal container width so
         the image can take up most of the viewport. */
      .reader {display:flex;gap:1rem;align-items:center; height: calc(100vh - 220px); margin:1rem auto 0; width:auto; max-width:1100px; justify-content:center}
      /* Fullscreen-like single page appearance: dark background and centered image */
      .page {
        /* two pages side-by-side, each takes about half of the reader area
           but constrained so the spread is centered */
        flex:0 0 calc(50% - 0.5rem);
        height:100%;
        border-radius:6px;
        padding:0;
        display:flex;
        align-items:center;
        justify-content:center;
        background:#000; /* dark background so pages "pop" */
        overflow:hidden;
      }
      .page img{max-width:100%;max-height:100%;object-fit:contain;display:block}
      /* single page view: take full width */
      .page.single{flex:0 0 100%}
      .reader-controls{margin:1rem 0;display:flex;gap:.5rem;align-items:center}
      .primary{background:var(--accent);color:#fff;padding:.5rem .8rem;border-radius:6px;border:none}
      /* Page number input */
      #pageInput{width:72px;padding:.4rem;border:1px solid #e5e7eb;border-radius:6px}
    </style>
  </head>
  <body>
    <div class="container">
      <nav class="nav">
        <div class="nav-left">
          <a href="/" class="logo">Kids Book Club</a>
        </div>
        <div class="nav-right">
          <a href="/books">Номнууд</a>
          {% if session.get('username') %}
            <span class="profile-pill">{{ session.username }}</span>
            <a href="/profile">Профайл</a>
            <a href="/logout">Гарах</a>
          {% else %}
            <a href="/login" class="login-button">Log in</a>
          {% endif %}
        </div>
      </nav>

      <main>
        <a href="{{ url_for('book_detail', book_id=book.id) }}" class="back">← Номны дэлгэрэнгүй руу буцах</a>
        <h1>Уншиж байна: {{ book.title }}</h1>

        <div class="reader-controls">
        <button id="prev" class="primary">Өмнөх</button>
        <button id="toggleSingle" class="primary">Нэг хуудас</button>
        <button id="fullscreenBtn" class="primary">Бүх хуудас</button>
        <div style="font-weight:600">Page <span id="pageNum">1</span></div>
        <input type="number" id="pageInput" min="1" value="1" />
        <div id="pageOf" style="color:#374151;margin-left:4px">/ 0</div>
        <button id="next" class="primary">Next</button>
        </div>

        <div class="reader" id="reader">
          {% if pages and pages|length > 0 %}
            <div class="page"><img src="{{ pages[0] }}" /></div>
            <div class="page">{% if pages|length > 1 %}<img src="{{ pages[1] }}" />{% endif %}</div>
          {% else %}
            <div class="page"></div>
            <div class="page"></div>
          {% endif %}
        </div>
        <script id="pages-data" type="application/json">{{ pages|tojson|safe }}</script>
        <section id="reader-debug" style="margin-top:1rem;font-size:.9rem;color:#374151">
          <details>
            <summary>Pages (debug)</summary>
            <div id="pages-list">Loading…</div>
          </details>
        </section>
      </main>
    </div>

      <script>
      // Reader that displays uploaded book pages (images) as a single fullscreen-like page.
      // Read pages data from the JSON script tag (safe and avoids JS parsing issues)
      let pages = [];
      try{
        const el = document.getElementById('pages-data')
        pages = JSON.parse(el && el.textContent ? el.textContent : '[]')
      }catch(e){ console.warn('Invalid pages JSON', e) }

      // populate debug area with links and thumbnails
      try{
        const list = document.getElementById('pages-list')
        if(list){
          if(!pages || pages.length===0) list.innerHTML = '<em>No pages uploaded</em>'
          else list.innerHTML = pages.map((u,i)=>`<div style="margin:6px 0"><strong>#${i+1}</strong> <a href="${u}" target="_blank">${u}</a><br/><img src="${u}" style="max-width:160px;max-height:120px;border:1px solid #eee;margin-top:6px" onerror="this.style.opacity=0.6;this.title='Failed to load'"/></div>`).join('')
        }
      }catch(e){ console.warn('Debug render failed', e) }

      // Setup variables
      let pageIndex = 0 // zero-based index of left page
      let singlePageMode = false
      const pageNum = document.getElementById('pageNum')
      const pageInput = document.getElementById('pageInput')
      const pageOf = document.getElementById('pageOf')
      const reader = document.getElementById('reader')
      const toggleSingle = document.getElementById('toggleSingle')
      const fullscreenBtn = document.getElementById('fullscreenBtn')

      function clampIndex(i){
        return Math.max(0, Math.min(i, Math.max(0, pages.length - 1)))
      }

      function render(){
        reader.innerHTML = ''
        if(singlePageMode){
          const single = document.createElement('div')
          single.className = 'page single'
          if(pages.length > pageIndex){
            const img = document.createElement('img')
            img.src = pages[pageIndex]
            single.appendChild(img)
          }
          reader.appendChild(single)
        } else {
          const left = document.createElement('div')
          left.className = 'page'
          const right = document.createElement('div')
          right.className = 'page'

          // left page
          if(pages.length > pageIndex){
            const img = document.createElement('img')
            img.src = pages[pageIndex]
            left.appendChild(img)
          }

          // right page (next)
          if(pages.length > pageIndex + 1){
            const img = document.createElement('img')
            img.src = pages[pageIndex + 1]
            right.appendChild(img)
          }

          reader.appendChild(left)
          reader.appendChild(right)
        }

        pageNum.textContent = (pageIndex + 1)
        pageInput.value = (pageIndex + 1)
        pageOf.textContent = '/ ' + (pages.length || 0)

        // toggle prev/next disabled state
        document.getElementById('prev').disabled = (pageIndex <= 0)
        document.getElementById('next').disabled = (pageIndex + (singlePageMode ? 1 : 2) > pages.length - 1)
      }

      document.getElementById('prev').addEventListener('click', ()=>{
        if(singlePageMode){
          if(pageIndex - 1 >= 0){ pageIndex = clampIndex(pageIndex - 1); render() }
          else { pageIndex = 0; render() }
        } else {
          if(pageIndex - 2 >= 0){ pageIndex = clampIndex(pageIndex - 2); render() }
          else { pageIndex = 0; render() }
        }
      })

      document.getElementById('next').addEventListener('click', ()=>{
        if(singlePageMode){
          if(pageIndex + 1 < pages.length){ pageIndex = clampIndex(pageIndex + 1); render() }
        } else {
          if(pageIndex + 2 < pages.length){ pageIndex = clampIndex(pageIndex + 2); render() }
        }
      })

      pageInput.addEventListener('change', ()=>{
        let v = parseInt(pageInput.value, 10) || 1
        v = Math.max(1, Math.min(v, pages.length || 1))
        // set left page index to the chosen page (zero-based)
        pageIndex = clampIndex(v - 1)
        render()
      })

      // keyboard navigation
      window.addEventListener('keydown', (e)=>{
        if(e.key === 'ArrowLeft'){
          if(singlePageMode){
            if(pageIndex - 1 >= 0){ pageIndex = clampIndex(pageIndex - 1); render() }
            else if(pageIndex > 0){ pageIndex = 0; render() }
          } else {
            if(pageIndex - 2 >= 0){ pageIndex = clampIndex(pageIndex - 2); render() }
            else if(pageIndex > 0){ pageIndex = 0; render() }
          }
        } else if(e.key === 'ArrowRight'){
          if(singlePageMode){
            if(pageIndex + 1 < pages.length){ pageIndex = clampIndex(pageIndex + 1); render() }
          } else {
            if(pageIndex + 2 < pages.length){ pageIndex = clampIndex(pageIndex + 2); render() }
          }
        }
      })

      // initial setup
      pageOf.textContent = '/ ' + (pages.length || 0)
      if(pages.length === 0){
        pageInput.disabled = true
        document.getElementById('prev').disabled = true
        document.getElementById('next').disabled = true
      }

      render()
      // wire toggle and fullscreen controls
      if(toggleSingle){
        toggleSingle.addEventListener('click', ()=>{
          singlePageMode = !singlePageMode
          toggleSingle.textContent = singlePageMode ? 'Two page' : 'Single page'
          // when switching to two-page view make sure left page index is even
          if(!singlePageMode){ pageIndex = Math.max(0, pageIndex - (pageIndex % 2)) }
          render()
        })
      }
      if(fullscreenBtn){
        fullscreenBtn.addEventListener('click', ()=>{
          const el = document.getElementById('reader')
          if(!el) return
          if(document.fullscreenElement){
            document.exitFullscreen().catch(()=>{})
          } else {
            if(el.requestFullscreen){ try{ el.requestFullscreen() }catch(e){} }
            else if(el.webkitRequestFullscreen){ try{ el.webkitRequestFullscreen() }catch(e){} }
            else if(el.msRequestFullscreen){ try{ el.msRequestFullscreen() }catch(e){} }
          }
        })
      }
    </script>
    {% if session.get('user_id') %}
    <script>
      // Start a reading session when the reader loads and stop on unload.
      (function(){
        let readerSessionId = null
        const bookId = {{ book.id | tojson }}

        function startSession(){
          try{
            fetch('/reading/start', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              credentials: 'same-origin',
              body: JSON.stringify({book_id: bookId})
            }).then(r=>r.json()).then(j=>{ if(j && j.session_id) readerSessionId = j.session_id }).catch(()=>{})
          }catch(e){}
        }

        function stopSession(){
          try{
            if(!readerSessionId) return
            fetch('/reading/stop', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              credentials: 'same-origin',
              body: JSON.stringify({session_id: readerSessionId}),
              keepalive: true
            }).catch(()=>{})
          }catch(e){}
        }

        // start immediately
        startSession()

        // attempt to stop when the page is unloaded
        window.addEventListener('beforeunload', stopSession)
        // also stop when the document becomes hidden (user switches tabs) to be conservative
        document.addEventListener('visibilitychange', function(){ if(document.hidden) stopSession() })
      })()
    </script>
    {% endif %}
  </body>
  </html>
